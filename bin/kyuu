#!/bin/bash

OPTIND=1         # Reset in case getopts has been used previously in the shell.

# Initialize our own variables:
_server_address=""
_stop=""
_rm=""
_verbose=""
_flush=""
_debug=""
_symlink=""

while getopts "a:h?srvfdl" opt; do
    case "$opt" in
    h|\?)
        echo " Specify -a followed by a url/port to connect to that server."
        echo " Specify -d to turn on debug mode."
        echo " Specify -f followed by followed by a list of kyuu names to flush named kyuus of messages. Specifying -v will list all of the messages flushed."
        echo " Specify -h to show this help."
        echo " Specify -l to create queues and then symlink them to the current directory."
        echo " Specify -r followed by a list of kyuu names to delete kyuus and their local symlinks."
        echo " Specify -s to shut down."
        echo " Specify -v for verbose output."
        exit 0
        ;;
    a)  _server_address=$OPTARG
        ;;
    s)  _stop=1
        ;;
    r)  _rm=1
        ;;
    v)  _verbose=1
        ;;
    f)  _flush=1
        ;;
    d)  _debug=1
        ;;
    l)  _symlink=1
        ;;
    esac
done

[ "${1:-}" = "--" ] && shift

shift $((OPTIND-1))

if [[ $_flush ]]
then
    for queue in $@
    do
        while true
        do
            val=`cat $KYUUPATH/$queue`
            if [[ ! $val ]]
            then
                break
            fi

            if [[ $_verbose ]]
            then
                echo $val
            fi
        done
    done

    exit 0
fi

if [[ $_stop ]]
then
    echo "shutting down."
    fusermount -u $KYUUPATH
    killall kyuuD
    echo "shut down succesfully."
    exit 0
fi

if [[ $_rm ]]
then
    for file in $@
    do
        if [[ $_verbose ]]
        then
            echo "rm'ing $file"
        fi

        rm $file
        rm $KYUUPATH/$file
    done
    exit 0
fi

if [ ! -f "$KYUUPATH/.kyuu_ctl" ]
then
    # If there's no mounted server, and if we aren't trying
    # to connect to a remote server, then spin a local one up.
    if [[ ! $_server_address ]]
    then
        if [[ $_verbose ]]
        then
            echo "No remote server specified, and no .kyuu_ctl file found. Spinning up a local kyuuD."
        fi

        if [[ $_debug ]]
        then
            kyuuD -v &
        else
            kyuuD &
        fi
    fi

    # if no remote server has been specified, set the
    # address as the default
    if [[ ! $_server_address ]]
    then
        _server_address=127.0.0.1:5640
    fi

    sleep 1

    if [ -z $KYUUPATH ]
    then
        echo "Making a folder for the kyuus at $HOME/kyuus."
        mkdir $HOME/.kyuus
        export KYUUPATH=$HOME/.kyuus
    fi

    # Mount our kyuu dameon vfs
    if [[ $_debug ]]
    then
        9pfuse -D $_server_address $KYUUPATH
    else
        9pfuse $_server_address $KYUUPATH
    fi
fi

# create and link the queue
for file in $@
do
    if [ -f $KYUUPATH/$file ]
    then
        echo "$file already exists in $KYUUPATH"
    else
        touch $KYUUPATH/$file
    fi

    if [[ $_symlink ]]
    then
        if [ -f $file ]
        then
            echo "$file already exists in local directory"
        else
            ln -s $KYUUPATH/$file .
        fi
    fi
done
